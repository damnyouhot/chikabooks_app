rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // íŒŒíŠ¸ë„ˆ ê·¸ë£¹
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /partnerGroups/{groupId} {
      // ê·¸ë£¹ ë©¤ë²„ë§Œ ì½ê¸° ê°€ëŠ¥
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.memberUids;
      // ì“°ê¸°ëŠ” ì„œë²„ë§Œ (Cloud Functions)
      allow write: if false;

      // â”€â”€ ìŠ¬ë¡¯ (ì„œë²„ë§Œ ì“°ê¸°) â”€â”€
      match /slots/{slotId} {
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
        allow write: if false; // ì„œë²„ë§Œ
      }

      // â”€â”€ ì´ë²¤íŠ¸ ë¡œê·¸ (ì„œë²„ ë‚´ë¶€ìš©) â”€â”€
      match /events/{eventId} {
        allow read: if false; // í´ë¼ì´ì–¸íŠ¸ ì½ê¸° ê¸ˆì§€
        allow write: if false; // ì„œë²„ë§Œ
      }

      // â”€â”€ ë©¤ë²„ ë©”íƒ€ â”€â”€
      match /memberMeta/{uid} {
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
        allow write: if false;
      }

      // â”€â”€ í™œë™ ë¡œê·¸ (ê¸°ì¡´) â”€â”€
      match /activityLogs/{logId} {
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
        allow write: if false;
      }

      // â”€â”€ ê²Œì‹œë¬¼ (bondGroups ë‚´ë¶€) â”€â”€
      match /posts/{postId} {
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
        allow write: if request.auth != null && 
                        request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;

        // â”€â”€ ì¶”ëŒ€ ì„œë¸Œì»¬ë ‰ì…˜ â”€â”€
        match /enthrones/{enthUID} {
          allow read: if request.auth != null && 
                         request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
          allow create: if request.auth != null && 
                           request.auth.uid == enthUID &&
                           request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
          allow delete: if request.auth != null && request.auth.uid == enthUID;
        }
      }

      // â”€â”€ ì¼ì¼ ìš”ì•½ â”€â”€
      match /dailySummaries/{dateKey} {
        allow read: if request.auth != null && 
                       request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
        allow write: if false; // ì„œë²„ë§Œ (Cloud Functions)
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ìœ ì €
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid;

      // â”€â”€ íŒŒíŠ¸ë„ˆ ì¸ë°•ìŠ¤ (ì„œë²„ë§Œ ì“°ê¸°) â”€â”€
      match /partnerInbox/{inboxId} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if false; // ì„œë²„ë§Œ
      }

      // â”€â”€ ğŸ“ ë‚˜ë§Œ ë³´ëŠ” í•œ ì¤„ ê¸°ë¡ (notes) â”€â”€
      match /notes/{noteId} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if request.auth != null && request.auth.uid == uid;
      }

      // â”€â”€ ì°¨ë‹¨í•œ ì‚¬ìš©ì ëª©ë¡ (blockedUsers) â”€â”€
      match /blockedUsers/{blockedUid} {
        allow read: if request.auth != null && request.auth.uid == uid;
        allow write: if request.auth != null && request.auth.uid == uid;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì£¼ê°„ ëª©í‘œ (Weekly Goals)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /weeklyGoals/{docId} {
      // docId í˜•ì‹: {uid}_{weekKey} (ì˜ˆ: abc123_2026-W07)
      allow read, write: if request.auth != null && 
        docId.matches('^' + request.auth.uid + '_.*');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ê²°ì„ ê°™ì´í•˜ê¸° ê²Œì‹œë¬¼ (Bond Posts)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /bondPosts/{postId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ìœ ì € (ë‹¨, ìˆ¨ê¹€ ì²˜ë¦¬ëœ ê¸€ ì œì™¸)
      allow read: if request.auth != null;
      
      // ì“°ê¸°: ë¡œê·¸ì¸í•œ ìœ ì €, ìì‹ ì˜ uidë¡œë§Œ ì‘ì„±
      allow create: if request.auth != null && 
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.text is string &&
        request.resource.data.text.size() <= 200 &&
        request.resource.data.dateKey is string &&
        request.resource.data.timeSlot is string &&
        request.resource.data.bondGroupId is string &&
        request.resource.data.reports == 0;
      
      // ìˆ˜ì •: ë³¸ì¸ ê²Œì‹œë¬¼ë§Œ
      allow update: if request.auth != null && 
        resource.data.uid == request.auth.uid;
      
      // ì‚­ì œ: ë³¸ì¸ ê²Œì‹œë¬¼ë§Œ
      allow delete: if request.auth != null && 
        resource.data.uid == request.auth.uid;

      // â”€â”€ ì‹ ê³  ì„œë¸Œì»¬ë ‰ì…˜ â”€â”€
      match /reports/{reportId} {
        // ì½ê¸°: ë³¸ì¸ì´ ì‹ ê³ í•œ ê¸°ë¡ë§Œ í™•ì¸ ê°€ëŠ¥
        allow read: if request.auth != null && 
          reportId == request.auth.uid;
        // ì“°ê¸°: ë¡œê·¸ì¸í•œ ìœ ì €ë§Œ (ì¤‘ë³µ ì‹ ê³ ëŠ” ì„œë¹„ìŠ¤ ë¡œì§ì—ì„œ ì²˜ë¦¬)
        allow create: if request.auth != null && 
          request.resource.data.reporterUid == request.auth.uid;
        allow update, delete: if false; // ì‹ ê³ ëŠ” ìƒì„±ë§Œ ê°€ëŠ¥
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ì „ê´‘íŒ ê²Œì‹œë¬¼ (Billboard Posts)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /billboardPosts/{postId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ëª¨ë“  ìœ ì €
      allow read: if request.auth != null;
      // ì“°ê¸°: ì„œë²„ë§Œ (Cloud Functions)
      allow write: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // íŒŒíŠ¸ë„ˆ ê·¸ë£¹ ë‚´ ì£¼ê°„ ìŠ¤íƒ¬í”„
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /partnerGroups/{groupId}/weeklyStamps/{stampId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/partnerGroups/$(groupId)).data.memberUids;
      allow write: if false; // ì„œë²„ë§Œ
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” API í‚¤ (ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì ì½ê¸° ê°€ëŠ¥, ì“°ê¸°ëŠ” ê¸ˆì§€)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /api_keys/{keyDoc} {
      allow read: if request.auth != null; // ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì
      allow write: if false; // ì½˜ì†” ë˜ëŠ” ì„œë²„ì—ì„œë§Œ ìˆ˜ì •
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš™ï¸ ì„¤ì • (ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì ì½ê¸° ê°€ëŠ¥)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /config/{docId} {
      allow read: if request.auth != null; // ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ì
      allow write: if false; // ì½˜ì†”ì—ì„œë§Œ ìˆ˜ì •
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“‹ HIRA ì—…ë°ì´íŠ¸ (ê¸‰ì—¬/ìˆ˜ê°€ ë³€ê²½)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /content_hira_updates/{updateId} {
      allow read: if request.auth != null;
      allow write: if false; // Cloud Functionsë§Œ
      
      // â”€â”€ ëŒ“ê¸€ ì„œë¸Œì»¬ë ‰ì…˜ â”€â”€
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && 
          request.resource.data.uid == request.auth.uid &&
          request.resource.data.text is string &&
          request.resource.data.text.size() > 0 &&
          request.resource.data.text.size() <= 500;
        allow delete: if request.auth != null && 
          resource.data.uid == request.auth.uid;
        allow update: if false; // ëŒ“ê¸€ ìˆ˜ì • ë¶ˆê°€
      }
    }

    match /content_hira_digest/{dateKey} {
      allow read: if request.auth != null;
      allow write: if false; // Cloud Functionsë§Œ
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’¾ HIRA ì €ì¥ ëª©ë¡ (ì‚¬ìš©ìë³„)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /users/{uid}/saved_hira_updates/{updateId} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null && request.auth.uid == uid;
      allow delete: if request.auth != null && request.auth.uid == uid;
      allow update: if false; // ìƒì„±/ì‚­ì œë§Œ, ìˆ˜ì • ë¶ˆí•„ìš”
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ê¸°íƒ€ ì»¬ë ‰ì…˜ (ì„ì‹œë¡œ ì „ì²´ í—ˆìš© - ë‚˜ì¤‘ì— ì„¸ë¶„í™” í•„ìš”)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /{document=**} {
      allow read, write: if true;
    }
  }
}